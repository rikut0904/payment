<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>
    <%= title %>
  </title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.css" rel="stylesheet"
    crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel='stylesheet' href='/stylesheets/style.css' />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
</head>

<body data-skip-auth-redirect="true">
  <div class="layout">
    <%- include('../partials/header', { title }) %>
      <div class="content">
        <section class="card">
          <h3>サマリー</h3>
          <div class="dashboard-summary">
            <article class="card-panel">
              <header class="card-panel__header">
                <div class="card-panel__title-block">
                  <div class="card-panel__title-row">
                    <h4>今月のサマリー</h4>
                  </div>
                </div>
              </header>
              <!-- 今月の支払額をfirebaseから取得して日本円に変換して表示。為替レートは外部APIを利用して取得 -->
              <div class="card-panel__body">
                <dl class="detail-list">
                  <div>
                    <dt>デビットカード支払い額</dt>
                    <dd>
                      <%= debitTotalFormatted || '¥0' %>
                    </dd>
                  </div>
                  <div>
                    <dt>クレジットカード支払い額</dt>
                    <dd>
                      <%= creditTotalFormatted || '¥0' %>
                    </dd>
                  </div>
                <div>
                  <dt>月額合計</dt>
                  <dd>
                    <%= monthlyTotal?.formattedTotal || '¥0' %>
                    <% if (hasConversionWarning) { %>
                      <small class="muted">※換算できない通貨を含みます</small>
                    <% } %>
                  </dd>
                </div>
                </dl>
              </div>
            </article>
            <!-- データをroutes/dashboard.jsの historyTotalsから取得 -->
            <!-- グラフ描画はpublic/javascripts/dashboard.jsで行う -->
            <article class="card-panel">
              <header class="card-panel__header">
                <div class="card-panel__title-block">
                  <div class="card-panel__title-row">
                    <h4>過去5か月の支払額推移</h4>
                  </div>
                </div>
              </header>
              <div class="card-panel__body">
                <!-- グラフの高さ計算用：5ヶ月の中の最大値を取得して棒グラフの高さを計算する -->
                <% const maxTotal = Number(historyMaxTotal) || 0; %>
                <div class="chart-wrapper">
                  <div class="bar-chart">
                    <!-- 各月の棒グラフを生成 -->
                    <!-- historyTotals: [{ monthKey, monthLabel, totalAmount, formattedTotal }, ...] -->
                    <% (historyTotals || []).forEach(function(item) { %>
                      <!-- 今月の支払額 -->
                      <% const totalAmount = Number(item.totalAmount) || 0; %>
                      <!-- 棒グラフの高さを計算 -->
                      <!-- 高さ = (今月の支払額 / 最大値) * 100% -->
                      <!-- 最小値4%（0円でも視覚的に表示） -->
                      <% const rawPercent = maxTotal ? Math.round((totalAmount / maxTotal) * 100) : 0; %>
                      <% const heightValue = Number.isFinite(rawPercent) ? Math.max(4, rawPercent) : 4; %>

                      <!-- 1つの棒グラフ要素 -->
                      <div class="bar-chart__item">
                        <div class="bar-chart__bar-wrap">
                          <!-- 棒グラフ本体 -->
                          <!-- data-height属性に高さの割合（%）を設定 -->
                          <!-- JavaScriptで読み取ってCSSのheightプロパティに適用 -->
                          <div class="bar-chart__bar" data-height="<%= heightValue %>"></div>
                        </div>
                        <!-- 月のラベル（例: "2025年12月"） -->
                        <div class="bar-chart__label">
                          <%= item.monthLabel %>
                        </div>
                        <!-- 支払額の表示（例: "¥12,345"） -->
                        <div class="bar-chart__value">
                          <%= item.formattedTotal %>
                        </div>
                      </div>
                    <% }); %>
                  </div>
                </div>
              </div>
            </article>
          </div>
        </section>
        <section class="card">
          <h3>今月の支払い予定</h3>
          <% if (currentMonthPayments && currentMonthPayments.length) { %>
            <div class="table-wrapper">
              <table class="table">
                <thead>
                  <tr>
                    <th>日付</th>
                    <th>サービス</th>
                    <th>カード</th>
                    <th>金額</th>
                  </tr>
                </thead>
                <tbody>
                  <% currentMonthPayments.forEach(function(payment) { %>
                    <tr>
                      <td>
                        <%= payment.formattedDate %>
                      </td>
                      <td>
                        <%= payment.subscriptionName %>
                      </td>
                      <td class="muted">
                        <%= payment.cardName %>
                      </td>
                      <td>
                        <%= payment.formattedAmount %>
                      </td>
                    </tr>
                    <% }); %>
                </tbody>
              </table>
            </div>
            <% } else { %>
              <p class="muted">今月の支払い予定はありません。</p>
              <% } %>
        </section>
      </div>
      <footer>
        <p>&copy; 2025 <%= projectName %>. All rights reserved.</p>
      </footer>
  </div>
  <script id="firebase-config" type="application/json"><%- JSON.stringify(firebaseConfig || {}) %></script>
  <script type="module" src="/javascripts/firebase-auth.js" defer></script>
  <script type="module" src="/javascripts/dashboard.js" defer></script>
</body>

</html>
