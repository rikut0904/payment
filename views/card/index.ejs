<!DOCTYPE html>
<html>

<head>
  <title>
    <%= title %>
  </title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.css" rel="stylesheet"
    crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel='stylesheet' href='/stylesheets/style.css' />
</head>

<body data-skip-auth-redirect="true">
  <div class="layout">
    <%- include('../partials/header', { title }) %>
      <div class="content">
        <section>
          <% if (typeof notice !=='undefined' && notice) { %>
            <div class="alert alert-success">
              <%= notice %>
            </div>
            <% } %>
              <% if (typeof error !=='undefined' && error) { %>
                <div class="alert alert-error">
                  <%= error %>
                </div>
                <% } %>
                  <div class="action-buttons">
                    <a href="/card/add" class="btn">カードを登録</a>
                    <a href="/card/subscription" class="btn btn-outline">サブスクリプションを登録</a>
                  </div>
        </section>

        <section class="card">
          <h3>登録済みカード</h3>
          <% if (cards && cards.length) { %>
            <div class="card-list">
              <% cards.forEach(function(card) { %>
                <article class="card-panel">
                  <header class="card-panel__header">
                    <div class="card-panel__title-block">
                      <div class="card-panel__title-row">
                        <h4>
                          <%= card.cardName %>
                        </h4>
                        <details class="card-menu">
                          <summary><span class="material-icons">more_vert</span></summary>
                          <div class="card-menu__list">
                            <a class="card-menu__item" href="/card/subscription?cardId=<%= card.id %>">このカードにサブスクを追加</a>
                            <a class="card-menu__item" href="/card/edit/<%= card.id %>">カードを編集</a>
                            <form method="post" action="/card/delete/<%= card.id %>"
                              onsubmit="return confirm('このカードを削除しますか？紐づくサブスクは残ります。');">
                              <button type="submit" class="card-menu__item card-menu__item--danger">カードを削除</button>
                            </form>
                          </div>
                        </details>
                      </div>
                      <p class="card-panel__subtitle">
                        <span class="badge">
                          <%= card.cardBrand || 'その他' %>
                        </span>
                        <span class="badge badge-outline">
                          <%= card.cardTypeLabel || '' %>
                        </span>
                        <span>末尾: **** <%= card.last4Digits || '----' %></span>
                      </p>
                    </div>
                    <dl class="card-panel__meta">
                      <% if (card.cardType==='credit' ) { %>
                        <div>
                          <dt>締め日</dt>
                          <dd>
                            <%= card.closingDayDisplay %>
                          </dd>
                        </div>
                        <div>
                          <dt>支払日</dt>
                          <dd>
                            <%= card.paymentDayDisplay %>
                          </dd>
                        </div>
                        <div>
                          <dt>利用上限</dt>
                          <dd>
                            <%= card.limitAmountDisplay %>
                          </dd>
                        </div>
                        <div>
                          <dt>サブスク合計</dt>
                          <dd>
                            <%= card.formattedSubscriptionTotal %>
                              <% if (card.conversionWarning) { %>
                                <small class="muted">※換算できない通貨を含みます</small>
                                <% } %>
                          </dd>
                        </div>
                        <% } else { %>
                          <div>
                            <dt>支払合計</dt>
                            <dd>
                              <%= card.formattedSubscriptionTotal %>
                                <% if (card.conversionWarning) { %>
                                  <small class="muted">※換算できない通貨を含みます</small>
                                  <% } %>
                            </dd>
                          </div>
                          <% } %>
                    </dl>
                  </header>
                  <details class="card-subscription-accordion" <%=card.subscriptions && card.subscriptions.length ? ''
                    : 'open' %>>
                    <summary>
                      <span>紐づくサブスクリプション</span>
                      <% if (card.subscriptions && card.subscriptions.length) { %>
                        <span class="badge badge-light">
                          <%= card.subscriptions.length %>件
                        </span>
                        <% } %>
                          <span class="accordion-icon" aria-hidden="true">▼</span>
                    </summary>
                    <div class="card-panel__body">
                      <% if (card.subscriptions && card.subscriptions.length) { %>
                        <div class="table-wrapper">
                          <table class="table">
                            <thead>
                              <tr>
                                <th>サービス名</th>
                                <th>金額</th>
                                <th>サイクル</th>
                                <th>登録メール</th>
                                <th>開始日</th>
                                <th>備考</th>
                              </tr>
                            </thead>
                            <tbody>
                              <% card.subscriptions.forEach(function(sub) { %>
                                <tr>
                                  <td>
                                    <%= sub.serviceName %>
                                  </td>
                                  <td>
                                    <%= sub.formattedAmount %>
                                  </td>
                                  <td>
                                    <%= sub.cycleLabel %>
                                  </td>
                                  <td>
                                    <%= sub.registeredEmail || '-' %>
                                  </td>
                                  <td>
                                    <%= sub.paymentStartDateDisplay %>
                                  </td>
                                  <td>
                                    <%= sub.notes || '-' %>
                                  </td>
                                </tr>
                                <% }); %>
                            </tbody>
                          </table>
                        </div>
                        <% } else { %>
                          <p class="muted">このカードに紐づくサブスクリプションはまだありません。</p>
                          <% } %>
                    </div>
                  </details>
                </article>
                <% }); %>
            </div>
            <% } else { %>
              <p class="muted">まだカードが登録されていません。まずはカードを追加してください。</p>
              <% } %>
        </section>

        <% if (unlinkedSubscriptions && unlinkedSubscriptions.length) { %>
          <section class="card warning">
            <h3>カード未紐付けのサブスクリプション</h3>
            <p>カードが削除された、または未登録の状態で作成されたサブスクリプションが存在します。</p>
            <ul class="warning-list">
              <% unlinkedSubscriptions.forEach(function(sub) { %>
                <li>
                  <strong>
                    <%= sub.serviceName %>
                  </strong>
                  - <%= sub.formattedAmount %> / 開始日: <%= sub.paymentStartDateDisplay %>
                </li>
                <% }); %>
            </ul>
          </section>
          <% } %>

            <section class="card">
              <h3>今後の支払い予定</h3>
              <% if (monthlyTotals && monthlyTotals.length) { %>
                <div class="summary-grid">
                  <% monthlyTotals.forEach(function(month) { %>
                    <div class="summary-item">
                      <span class="summary-label">
                        <%= month.monthLabel %>
                      </span>
                      <span class="summary-value">
                        <%= month.formattedTotal %>
                      </span>
                    </div>
                    <% }); %>
                </div>
                <% } %>
                  <div class="card-panel__meta payment-groups">
                    <div class="payment-group">
                      <h4>クレジットカード</h4>
                      <% if (upcomingPaymentsCredit && upcomingPaymentsCredit.length) { %>
                        <div class="table-wrapper">
                          <table class="table">
                            <thead>
                              <tr>
                                <th>支払日</th>
                                <th>サービス</th>
                                <th>カード</th>
                                <th>金額</th>
                              </tr>
                            </thead>
                            <tbody>
                              <% upcomingPaymentsCredit.forEach(function(payment) { %>
                                <tr>
                                  <td>
                                    <%= payment.formattedDate %>
                                  </td>
                                  <td>
                                    <%= payment.subscriptionName %>
                                  </td>
                                  <td>
                                    <%= payment.cardName %>
                                  </td>
                                  <td>
                                    <%= payment.formattedAmount %> <small>(<%= payment.cycleLabel %>)</small>
                                  </td>
                                </tr>
                                <% }); %>
                            </tbody>
                          </table>
                        </div>
                        <% } else { %>
                          <p class="muted">クレジットカードの支払い予定はありません。</p>
                          <% } %>
                    </div>
                    <div class="payment-group">
                      <h4>デビットカード</h4>
                      <% if (upcomingPaymentsDebit && upcomingPaymentsDebit.length) { %>
                        <div class="table-wrapper">
                          <table class="table">
                            <thead>
                              <tr>
                                <th>支払日</th>
                                <th>サービス</th>
                                <th>カード</th>
                                <th>金額</th>
                              </tr>
                            </thead>
                            <tbody>
                              <% upcomingPaymentsDebit.forEach(function(payment) { %>
                                <tr>
                                  <td>
                                    <%= payment.formattedDate %>
                                  </td>
                                  <td>
                                    <%= payment.subscriptionName %>
                                  </td>
                                  <td>
                                    <%= payment.cardName %>
                                  </td>
                                  <td>
                                    <%= payment.formattedAmount %> <small>(<%= payment.cycleLabel %>)</small>
                                  </td>
                                </tr>
                                <% }); %>
                            </tbody>
                          </table>
                        </div>
                        <% } else { %>
                          <p class="muted">デビットカードの支払い予定はありません。</p>
                          <% } %>
                    </div>
                  </div>
            </section>
      </div>
      <footer>
        <p>&copy; 2025 <%= projectName %>. All rights reserved.</p>
      </footer>
  </div>
  <script id="firebase-config" type="application/json"><%- JSON.stringify(firebaseConfig || {}) %></script>
  <script type="module" src="/javascripts/firebase-auth.js" defer></script>
  <script type="module" src="/javascripts/card-actions.js" defer></script>
</body>

</html>